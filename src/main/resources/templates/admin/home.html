<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>

    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>

<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container-fluid">
    <div class="row">

        <div class="col-md-3 col-lg-2 p-0">
            <div th:replace="~{fragments/sidebar :: sidebar('admin')}"></div>
        </div>

        <div class="col-md-9 col-lg-10 p-4">
            <h1 class="mb-3">Admin panel</h1>

            <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            th:classappend="${activeTab}=='users' ? ' active' : ''"
                            id="users-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#usersTab"
                            type="button">
                        Users
                    </button>
                </li>

                <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            th:classappend="${activeTab}=='newUser' ? ' active' : ''"
                            id="newuser-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#newUserTab"
                            type="button">
                        New User
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="adminTabsContent">

                <div class="tab-pane fade"
                     th:classappend="${activeTab}=='users' ? ' show active' : ''"
                     id="usersTab">
                    <div th:replace="~{fragments/user-table :: userTable(${users}, true)}"></div>
                </div>

                <div class="tab-pane fade"
                     th:classappend="${activeTab}=='newUser' ? ' show active' : ''"
                     id="newUserTab">
                    <div th:replace="~{fragments/user-form :: userForm(${user}, ${roles})}"></div>
                </div>

            </div>
        </div>

    </div>
</div>


<div th:replace="~{fragments/editModal :: editModal}"></div>
<div th:replace="~{fragments/deleteModal :: deleteModal}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const editModal = document.getElementById('editModal');
        if (!editModal) return;

        editModal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            if (!button) return;

            document.getElementById('edit-id').value = button.getAttribute('data-id') || '';
            document.getElementById('edit-firstName').value = button.getAttribute('data-firstname') || '';
            document.getElementById('edit-lastName').value  = button.getAttribute('data-lastname') || '';
            document.getElementById('edit-email').value     = button.getAttribute('data-email') || '';
            document.getElementById('edit-username').value  = button.getAttribute('data-username') || '';

            const select = document.getElementById('edit-roles');

            Array.from(select.options).forEach(o => o.selected = false);

            const rolesStr = button.getAttribute('data-roles') || ''; // "1,2"
            const ids = rolesStr.split(',').map(s => s.trim()).filter(Boolean);

            ids.forEach(id => {
                const opt = select.querySelector(`option[value="${id}"]`);
                if (opt) opt.selected = true;
            });
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const deleteModal = document.getElementById('deleteModal');
        if (!deleteModal) return;

        deleteModal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            if (!button) return;

            document.getElementById('delete-id').value = button.getAttribute('data-id') || '';
            document.getElementById('delete-firstName').value = button.getAttribute('data-firstname') || '';
            document.getElementById('delete-lastName').value = button.getAttribute('data-lastname') || '';
            document.getElementById('delete-email').value = button.getAttribute('data-email') || '';
            document.getElementById('delete-username').value = button.getAttribute('data-username') || '';

            const select = document.getElementById('delete-roles');
            select.innerHTML = '';

            const rolesStr = button.getAttribute('data-roles') || '';
            const roles = rolesStr.split(',').map(s => s.trim()).filter(Boolean);

            roles.forEach(r => {
                const opt = document.createElement('option');
                opt.textContent = r.replace('ROLE_', '');
                opt.selected = true;
                select.appendChild(opt);
            });
        });
    });
</script>
</body>
</html>